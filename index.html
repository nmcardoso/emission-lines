<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emission Lines</title>
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
</head>

<body>
  <p>Load table: <input type="file" id="input">
    (<a href="emission_lines_crossmatch.csv">Click here</a> to download the table)
  </p>
  <p>
    Select <b>Z</b> search radius (in arcsec): <input type="text" id="radius" value="3" />
  </p>
  <p>
    <button id="load-table">LOAD TABLE</button>
  </p>
  <br>
  <p>Notes:
  <ul>
    <li>To load SDSS Spectra, this program looks first for <b>specObjID</b> column, if missing a cone search will be
      performed using <b>RA</b> and <b>DEC</b> columns with 1 arcsec of radius;</li>
    <li>To load SPLUS Spectra, a column called <b>ID</b> must be provided;</li>
    <li>To load Legacy Server Image, columns called <b>RA</b> and <b>DEC</b> must be provided;</li>
    <li>To load EW, a column called <b>EW_Ha_6562</b> must be provided;</li>
    <li>To load Subclass, this program looks first for <b>subclass</b> column, if missing a cone search will be
      performed using <b>RA</b> and <b>DEC</b> columns with 1 arcsec of radius.</li>
  </ul>
  </p>
  <br />
  <table id="table">
    <thead>
      <tr>
        <th>RA</th>
        <th>DEC</th>
        <th>EW</th>
        <th>Subclass</th>
        <th>Z</th>
        <th>SPEC</th>
        <th>S-SPEC</th>
        <th>Image</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"
    integrity="sha512-rKFvwjvE4liWPlFnvH4ZhRDfNZ9FOpdkD/BU5gAIA3VS3vOQrQ5BjKgbO3kxebKhHdHcNUHLqxQYSoxee9UwgA=="
    crossorigin="anonymous"></script>

  <script>
    function toNumber(n) {
      const parts = n.split('E+');
      let first = parts[0].replace('.', '').replace(',', '');
      const zeroes = parseInt(parts[1], 10) - (first.length - 1);
      for (let i = 0; i < zeroes; i++) { first += '0'; }
      return first
    }

    function findHeaderId(header, str) {
      return header.findIndex(e => {
        return String(e).toLowerCase().includes(String(str).toLowerCase())
      })
    }

    function sddsConeSearch(args) {
      fetch(`https://skyserver.sdss.org/dr16/SkyServerWS/SpectroQuery/ConeSpectro?radius=0.01667&dec=${args.dec}&ra=${args.ra}&limit=1&format=xml&specparams=specObjID,subclass&imgparams=none&zWarning=on`)
        .then(r => r.text())
        .then(str => (new DOMParser()).parseFromString(str, 'application/xml'))
        .then(data => {
          if (args.imageElement) {
            let id = data.querySelector('Table[name="Table1"] > Row > Item[name="specObjID"]')
            if (id) {
              const specUrl = `https://skyserver.sdss.org/dr16/en/get/SpecById.ashx?id=${id.textContent}`
              args.imageElement.innerHTML = `<a href="${specUrl}" data-lightbox="row-${args.rowId}"><img src="${specUrl}" width="180px" height="90px" loading="lazy" /></a>`
            }
          }

          if (args.subclassElement) {
            let subclass = data.querySelector('Table[name="Table1"] > Row > Item[name="subclass"]')
            subclass = subclass ? subclass.textContent : ''
            args.subclassElement.innerHTML = subclass
          }
        })
    }

    function redshiftSearch(ra, dec, element) {
      let delta = document.getElementById('radius').value
      if (!!delta) {
        delta = parseFloat(delta) / 3600
      } else {
        delta = 3.0 / 3600
      }

      fetch(`https://red-mirror.herokuapp.com/https://www.legacysurvey.org/viewer/spec/1/cat.json?ralo=${ra - delta}&rahi=${ra + delta}&declo=${dec - delta}&dechi=${dec + delta}`, { headers: { 'Origin': 'google.com' } })
        .then(r => r.json())
        .then(data => {
          const redshifts = []
          for (let i = 0; i < data.name.length; i++) {
            const raNear = data.rd[i][0]
            const decNear = data.rd[i][1]

            redshifts.push({
              ra: raNear,
              dec: decNear,
              name: data.name[i],
              dist: Math.sqrt(Math.pow(raNear - ra, 2) + Math.pow(decNear - dec, 2))
            })
          }
          element.innerHTML = redshifts.map(r => r.name).join('<hr>')
        })
    }

    function createTable(result) {
      const data = result.data
      const header = data[0]
      console.log(header)
      console.log(data.length)
      const specIdIdx = findHeaderId(header, 'specObjID')
      const raIdx = findHeaderId(header, 'ra')
      const decIdx = findHeaderId(header, 'dec')
      const ewIdx = findHeaderId(header, 'EW_Ha_6562')
      const subclassIdx = findHeaderId(header, 'subclass')
      const idIdx = header.findIndex(e => e == 'ID')
      const specArray = []
      const redshiftArray = []

      const tbody = document.getElementById('table').getElementsByTagName('tbody')[0]
      for (let i = 1; i < data.length; i++) {
        const row = tbody.insertRow()
        const cellRA = row.insertCell()
        const cellDEC = row.insertCell()
        const cellEW = row.insertCell()
        const cellSubclass = row.insertCell()
        const cellRedshift = row.insertCell()
        const cellSPEC = row.insertCell()
        const cellSplusSpec = row.insertCell()
        const cellImage = row.insertCell()

        const ra = data[i][raIdx]
        const dec = data[i][decIdx]

        cellRA.innerHTML = ra
        cellDEC.innerHTML = dec
        const sdssRow = {}

        if (ewIdx > -1) {
          cellEW.innerHTML = data[i][ewIdx]
        }
        if (subclassIdx > -1) {
          cellSubclass.innerHTML = data[i][subclassIdx]
        } else if (specIdIdx <= -1 || !!!data[i][specIdIdx]) {
          sdssRow.subclassElement = cellSubclass
        }
        if (specIdIdx > -1) {
          const specUrl = `https://skyserver.sdss.org/dr16/en/get/SpecById.ashx?id=${data[i][specIdIdx]}`
          cellSPEC.innerHTML = `<a href="${specUrl}" data-lightbox="row-${i}"><img src="${specUrl}" width="180px" height="90px" loading="lazy" /></a>`
        } else if (specIdIdx <= -1 || !!!data[i][specIdIdx]) {
          sdssRow.imageElement = cellSPEC
        }
        if (idIdx > -1) {
          const splusSpecUrl = `plots/${data[i][idIdx]}`
          cellSplusSpec.innerHTML = `<a href="${splusSpecUrl}" data-lightbox="row-${i}"><img src="${splusSpecUrl}" height="90px" loading="lazy" /></a>`
        }

        redshiftArray.push({ ra, dec, cellRedshift })
        const imgUrl = `https://www.legacysurvey.org/viewer/cutout.jpg?ra=${ra}&dec=${dec}&layer=dr8&pixscale=0.50`
        cellImage.innerHTML = `<a href="${imgUrl}" data-lightbox="row-${i}"><img src="${imgUrl}" height="90px" loading="lazy" /></a>`

        if ('subclassElement' in sdssRow || 'imageElement' in sdssRow) {
          sdssRow.ra = ra
          sdssRow.dec = dec
          sdssRow.rowId = i
          specArray.push(sdssRow)
        }
      }

      specArray.forEach(row => {
        sddsConeSearch(row)
      })
      redshiftArray.forEach(row => {
        redshiftSearch(row.ra, row.dec, row.cellRedshift)
      })
    }

    function handleFile() {
      document.getElementById('table').getElementsByTagName('tbody')[0].innerHTML = ''
      const file = document.getElementById('input').files[0]
      Papa.parse(file, {
        complete: createTable,
        dynamicTyping: true,
        skipEmptyLines: true
      })
    }

    // document.getElementById('input').addEventListener('change', handleFile, false)
    document.getElementById('load-table').addEventListener('click', handleFile, false)

    $(document).ready(() => {
      lightbox.option({
        fadeDuration: 180,
        imageFadeDuration: 180,
        resizeDuration: 180
      })
    })
  </script>
</body>

</html>