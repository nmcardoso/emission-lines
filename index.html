<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emission Lines</title>
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
</head>

<body>
  <p>Load table: <input type="file" id="input">
    (<a href="emission_lines_crossmatch.csv">Click here</a> to download the table)
  </p>
  <p>Notes:
  <ul>
    <li>To load SDSS Spectra, a column called <b>specObjID</b> must be provided;</li>
    <li>To load SPLUS Spectra, a column called <b>ID</b> must be provided;</li>
    <li>To load Legacy Server Image, columns called <b>RA</b> and <b>DEC</b> must be provided;</li>
    <li>To load EW, a column called <b>EW_Ha_6562</b> must be provided;</li>
    <li>To load Subclass, a column called <b>subclass</b> must be provided;</li>
  </ul>
  </p>
  <br />
  <table id="table">
    <thead>
      <tr>
        <th>RA</th>
        <th>DEC</th>
        <th>EW</th>
        <th>Subclass</th>
        <th>SPEC</th>
        <th>S-SPEC</th>
        <th>Image</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"
    integrity="sha512-rKFvwjvE4liWPlFnvH4ZhRDfNZ9FOpdkD/BU5gAIA3VS3vOQrQ5BjKgbO3kxebKhHdHcNUHLqxQYSoxee9UwgA=="
    crossorigin="anonymous"></script>

  <script>
    function toNumber(n) {
      const parts = n.split('E+');
      let first = parts[0].replace('.', '').replace(',', '');
      const zeroes = parseInt(parts[1], 10) - (first.length - 1);
      for (let i = 0; i < zeroes; i++) { first += '0'; }
      return first
    }

    function findHeaderId(header, str) {
      return header.findIndex(e => {
        return e.toLowerCase().includes(str.toLowerCase())
      })
    }

    function createTable(result) {
      const data = result.data
      const header = data[0]
      console.log(header)
      console.log(data.length)
      const specIdIdx = findHeaderId(header, 'specObjID')
      const raIdx = findHeaderId(header, 'ra')
      const decIdx = findHeaderId(header, 'dec')
      const ewIdx = findHeaderId(header, 'EW_Ha_6562')
      const subclassIdx = findHeaderId(header, 'subclass')
      const idIdx = header.findIndex(e => e == 'ID')

      const tbody = document.getElementById('table').getElementsByTagName('tbody')[0]
      for (let i = 1; i < data.length; i++) {
        const row = tbody.insertRow()
        const cellRA = row.insertCell()
        const cellDEC = row.insertCell()
        const cellEW = row.insertCell()
        const cellSubclass = row.insertCell()
        const cellSPEC = row.insertCell()
        const cellSplusSpec = row.insertCell()
        const cellImage = row.insertCell()

        const ra = data[i][raIdx]
        const dec = data[i][decIdx]

        cellRA.innerHTML = ra
        cellDEC.innerHTML = dec
        if (ewIdx > -1) {
          cellEW.innerHTML = data[i][ewIdx]
        }
        if (subclassIdx > -1) {
          cellSubclass.innerHTML = data[i][subclassIdx]
        }
        if (specIdIdx > -1) {
          const specUrl = `http://skyserver.sdss.org/dr16/en/get/SpecById.ashx?id=${data[i][specIdIdx]}`
          cellSPEC.innerHTML = `<a href="${specUrl}" data-lightbox="spec"><img src="${specUrl}" width="180px" height="90px" loading="lazy" /></a>`
        }
        if (idIdx > -1) {
          const splusSpecUrl = `plots/${data[i][idIdx]}`
          cellSplusSpec.innerHTML = `<a href="${splusSpecUrl}" data-lightbox="splus-spec"><img src="${splusSpecUrl}" height="90px" loading="lazy" /></a>`
        }
        const imgUrl = `https://www.legacysurvey.org/viewer/cutout.jpg?ra=${ra}&dec=${dec}&layer=dr8&pixscale=0.50`
        cellImage.innerHTML = `<a href="${imgUrl}" data-lightbox="legacy-rgb"><img src="${imgUrl}" height="90px" loading="lazy" /></a>`
      }
    }

    function handleFile() {
      const file = this.files[0]
      Papa.parse(file, {
        complete: createTable,
        dynamicTyping: true,
        skipEmptyLines: true
      })
    }

    document.getElementById('input').addEventListener('change', handleFile, false)

    $(document).ready(() => {
      lightbox.option({
        fadeDuration: 180,
        imageFadeDuration: 180,
        resizeDuration: 180
      })
    })
  </script>
</body>

</html>